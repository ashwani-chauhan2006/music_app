<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #121212;
            color: #fff;
        }

        .test-section {
            background: #282828;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .success {
            background: #1db954;
        }

        .error {
            background: #e74c3c;
        }

        .warning {
            background: #f39c12;
        }

        .info {
            background: #3498db;
        }

        button {
            background: #1db954;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #1ed760;
        }

        pre {
            background: #404040;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <h1>Firebase Configuration Test</h1>

    <div class="test-section">
        <h2>Step 1: Test Firebase Import</h2>
        <div id="import-status" class="status info">Testing Firebase imports...</div>
        <button onclick="testImports()">Test Imports</button>
    </div>

    <div class="test-section">
        <h2>Step 2: Test Firebase Initialization</h2>
        <div id="init-status" class="status info">Waiting for import test...</div>
        <button onclick="testInitialization()">Test Initialization</button>
    </div>

    <div class="test-section">
        <h2>Step 3: Test Authentication</h2>
        <div id="auth-status" class="status info">Waiting for initialization test...</div>
        <button onclick="testAuth()">Test Authentication</button>
        <button onclick="signIn()">Sign In</button>
    </div>

    <div class="test-section">
        <h2>Step 4: Test Firestore</h2>
        <div id="firestore-status" class="status info">Waiting for auth test...</div>
        <button onclick="testFirestore()">Test Firestore</button>
    </div>

    <div class="test-section">
        <h2>Console Logs</h2>
        <div id="logs"></div>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <script type="module">
        // Capture console logs
        const logsDiv = document.getElementById('logs');

        function addLog(message, type = 'log') {
            const logEntry = document.createElement('div');
            logEntry.style.cssText = `
                padding: 5px;
                margin: 2px 0;
                border-left: 3px solid ${type === 'error' ? '#e74c3c' : '#1db954'};
                background: #404040;
                font-family: monospace;
                font-size: 12px;
            `;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        const originalLog = console.log;
        const originalError = console.error;

        console.log = function (...args) {
            originalLog.apply(console, args);
            addLog(args.join(' '), 'log');
        };

        console.error = function (...args) {
            originalError.apply(console, args);
            addLog(args.join(' '), 'error');
        };

        // Global variables for testing
        let firebaseApp = null;
        let firebaseAuth = null;
        let firebaseFirestore = null;

        // Test 1: Imports
        window.testImports = async function () {
            try {
                addLog("Testing Firebase imports...");

                const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js");
                addLog("✓ Firebase App imported");

                const { getAuth } = await import("https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js");
                addLog("✓ Firebase Auth imported");

                const { getFirestore } = await import("https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js");
                addLog("✓ Firebase Firestore imported");

                document.getElementById('import-status').className = 'status success';
                document.getElementById('import-status').textContent = 'All Firebase imports successful!';

                // Store for next tests
                window.firebaseImports = { initializeApp, getAuth, getFirestore };

            } catch (error) {
                addLog(`✗ Import failed: ${error.message}`);
                document.getElementById('import-status').className = 'status error';
                document.getElementById('import-status').textContent = `Import failed: ${error.message}`;
            }
        };

        // Test 2: Initialization
        window.testInitialization = async function () {
            try {
                if (!window.firebaseImports) {
                    throw new Error("Please run import test first");
                }

                addLog("Testing Firebase initialization...");

                const firebaseConfig = {
                    apiKey: "AIzaSyD6zraP3KBgkAut4s81rM01KeSROBp2Z2U",
                    authDomain: "apma-music.firebaseapp.com",
                    projectId: "apma-music",
                    storageBucket: "apma-music.appspot.com",
                    messagingSenderId: "32855672499",
                    appId: "1:32855672499:web:b5d053f3f1840b000e12c6",
                    measurementId: "G-DS0PMWB0D9"
                };

                addLog("Firebase config:", JSON.stringify(firebaseConfig, null, 2));

                firebaseApp = window.firebaseImports.initializeApp(firebaseConfig);
                addLog("✓ Firebase app initialized");

                firebaseAuth = window.firebaseImports.getAuth(firebaseApp);
                addLog("✓ Firebase auth initialized");

                firebaseFirestore = window.firebaseImports.getFirestore(firebaseApp);
                addLog("✓ Firebase firestore initialized");

                document.getElementById('init-status').className = 'status success';
                document.getElementById('init-status').textContent = 'Firebase initialized successfully!';

            } catch (error) {
                addLog(`✗ Initialization failed: ${error.message}`);
                document.getElementById('init-status').className = 'status error';
                document.getElementById('init-status').textContent = `Initialization failed: ${error.message}`;
            }
        };

        // Test 3: Authentication
        window.testAuth = async function () {
            try {
                if (!firebaseAuth) {
                    throw new Error("Please run initialization test first");
                }

                addLog("Testing Firebase authentication...");

                const user = firebaseAuth.currentUser;
                if (user) {
                    addLog(`✓ User signed in: ${user.email}`);
                    document.getElementById('auth-status').className = 'status success';
                    document.getElementById('auth-status').textContent = `User signed in: ${user.email}`;
                } else {
                    addLog("ℹ No user signed in");
                    document.getElementById('auth-status').className = 'status warning';
                    document.getElementById('auth-status').textContent = 'No user signed in';
                }

            } catch (error) {
                addLog(`✗ Auth test failed: ${error.message}`);
                document.getElementById('auth-status').className = 'status error';
                document.getElementById('auth-status').textContent = `Auth test failed: ${error.message}`;
            }
        };

        // Sign in
        window.signIn = async function () {
            try {
                if (!firebaseAuth) {
                    throw new Error("Please run initialization test first");
                }

                addLog("Attempting Google sign in...");

                const { GoogleAuthProvider, signInWithPopup } = await import("https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js");
                const provider = new GoogleAuthProvider();

                const result = await signInWithPopup(firebaseAuth, provider);
                addLog(`✓ Signed in as: ${result.user.displayName} (${result.user.email})`);

                document.getElementById('auth-status').className = 'status success';
                document.getElementById('auth-status').textContent = `Signed in as: ${result.user.displayName}`;

            } catch (error) {
                addLog(`✗ Sign in failed: ${error.message}`);
                document.getElementById('auth-status').className = 'status error';
                document.getElementById('auth-status').textContent = `Sign in failed: ${error.message}`;
            }
        };

        // Test 4: Firestore
        window.testFirestore = async function () {
            try {
                if (!firebaseFirestore || !firebaseAuth) {
                    throw new Error("Please run initialization and auth tests first");
                }

                addLog("Testing Firestore...");

                const user = firebaseAuth.currentUser;
                if (!user) {
                    throw new Error("Please sign in first");
                }

                const { collection, getDocs, query, where } = await import("https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js");

                const q = query(collection(firebaseFirestore, "playlists"), where("createdBy", "==", user.uid));
                addLog("✓ Query created");

                const querySnapshot = await getDocs(q);
                addLog(`✓ Query executed, found ${querySnapshot.size} playlists`);

                const playlists = [];
                querySnapshot.forEach((doc) => {
                    playlists.push({ id: doc.id, ...doc.data() });
                });

                addLog("Playlists:", JSON.stringify(playlists, null, 2));

                document.getElementById('firestore-status').className = 'status success';
                document.getElementById('firestore-status').textContent = `Firestore test successful! Found ${playlists.length} playlists`;

            } catch (error) {
                addLog(`✗ Firestore test failed: ${error.message}`);
                document.getElementById('firestore-status').className = 'status error';
                document.getElementById('firestore-status').textContent = `Firestore test failed: ${error.message}`;
            }
        };

        // Clear logs
        window.clearLogs = function () {
            logsDiv.innerHTML = '';
        };

        // Auto-run first test
        window.addEventListener('load', () => {
            setTimeout(() => {
                testImports();
            }, 1000);
        });
    </script>
</body>

</html>